"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.C=exports.ASSETS=exports.METHODOLOGIES=void 0,exports.METHODOLOGIES=["MFIV"],exports.ASSETS=["ETH"],exports.C={HEARTBEAT:"9"};var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.debug=void 0;const debug_1=__importDefault(require("debug")),index_1=(exports.debug=(0,debug_1.default)("volatility-ws"),Object.defineProperty(exports,"__esModule",{value:!0}),require("./index")),realTimeMessages=(0,index_1.realtimeVolatility)({methodology:"MFIV",timePeriod:"14D",asset:"ETH",apiKey:process.env.VOLATILITY_API_KEY,idleTimeout:3e4,onError:e=>{console.error("** ERROR **",e)}}),processMessages=async()=>{for await(const e of realTimeMessages)console.log(e)};(async()=>{try{await processMessages()}catch(e){console.error("error",e)}})();var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&("get"in o?t.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){e[s=void 0===s?i:s]=t[i]}),__exportStar=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||__createBinding(t,e,i)},options_1=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.init=void 0,__exportStar(require("./consts"),exports),require("./options"));Object.defineProperty(exports,"init",{enumerable:!0,get:function(){return options_1.init}}),__exportStar(require("./realtime"),exports),__exportStar(require("./stream"),exports),__exportStar(require("./types"),exports),Object.defineProperty(exports,"__esModule",{value:!0}),exports.getOptions=exports.init=void 0;const pkg=require("../package.json"),defaultOptions={endpoint:"https://api.dev.volatility.dev/v1",apiKey:"",_userAgent:`volatility-ws/${pkg.version} (+https://github.com/VolatilityGroup/volatility-ws)`};let options={...defaultOptions};function init(e={}){options={...defaultOptions,...e}}function getOptions(){return options}exports.init=init,exports.getOptions=getOptions,Object.defineProperty(exports,"__esModule",{value:!0}),exports.realtimeVolatility=void 0;const debug_1=require("./debug"),utils_1=require("./utils"),realtime_1=require("./realtime");async function*_stream({methodology:e,timePeriod:t,asset:i,idleTimeout:s=3e4,withDisconnects:o=void 0,onError:r=void 0,apiKey:n=void 0}){for await(const a of(0,realtime_1.createRealTimeFeed)(e,t,i,s,r,n))!0===a._disconnect?o&&(yield void 0):yield{localTimestamp:new Date,message:a}}async function*_streamIndex({methodology:e,timePeriod:t,asset:i,apiKey:s,idleTimeout:o=3e4,withDisconnects:r=void 0,onError:n=void 0}){for(var a=(0,utils_1.normalizeId)({methodology:e,timePeriod:t,asset:i});;)try{var l=_stream({methodology:e,timePeriod:t,asset:i,withDisconnects:r,idleTimeout:o,onError:n,apiKey:s});for await(const d of(0,utils_1.preprocess)(e,t,i,l,r,new Date))yield{...d.message.data,localTimestamp:d.localTimestamp}}catch(e){void 0!==n&&n(e),(0,debug_1.debug)("%s index messages error: %o, retrying with new connection...",a,e),r&&(yield{type:"disconnect",id:a,localTimestamp:new Date})}}function realtimeVolatility({methodology:e,timePeriod:t,asset:i,apiKey:s,idleTimeout:o=3e4,withDisconnects:r=void 0,onError:n=void 0}){(0,debug_1.debug)(`methodology: ${e}
timePeriod: ${t}
asset: ${i}
apiKey: `+s);const a=_streamIndex({methodology:e,timePeriod:t,asset:i,idleTimeout:o,withDisconnects:r,onError:n,apiKey:s});return a.__realtime__=!0,a}exports.realtimeVolatility=realtimeVolatility,Object.defineProperty(exports,"__esModule",{value:!0});__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.httpsProxyAgent=exports.preprocess=exports.HttpError=exports.ONE_SEC_IN_MS=exports.normalizeId=exports.wait=void 0;const https_proxy_agent_1=__importDefault(require("https-proxy-agent"));function wait(t){return new Promise(e=>{setTimeout(e,t)})}function normalizeId({methodology:e,timePeriod:t,asset:i}){return e+`.${t},`+i}exports.wait=wait,exports.normalizeId=normalizeId,exports.ONE_SEC_IN_MS=1e3;class HttpError extends Error{constructor(e,t,i){super(`HttpError: status code: ${e}, response text: `+t),this.status=e,this.responseText=t,this.url=i}}async function*preprocess(e,t,i,s,o,r){let n=r;for await(const a of s)void 0===a?!0===o&&void 0!==n&&(yield{type:"disconnect",id:normalizeId({methodology:e,timePeriod:t,asset:i}),localTimestamp:n}):(n=a.localTimestamp,yield{...a,localTimestamp:n})}exports.HttpError=HttpError,exports.preprocess=preprocess,exports.httpsProxyAgent=void 0!==process.env.HTTP_PROXY?(0,https_proxy_agent_1.default)(process.env.HTTP_PROXY):void 0;__createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&("get"in o?t.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){e[s=void 0===s?i:s]=t[i]}),__exportStar=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||__createBinding(t,e,i)};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RealTimeBase=exports.createRealTimeFeed=void 0;const multifeed_1=require("./multifeed"),mfiv_1=require("./mfiv");function createRealTimeFeed(e,t,i,s,o,r){return new mfiv_1.RealTimeMfiv(e,t,i,s,r,o)}__exportStar(require("./realtimefeed"),exports),exports.createRealTimeFeed=createRealTimeFeed;class RealTimeBase extends multifeed_1.MultiplexBase{*_getRealTimeFeeds(e,t,i,s,o,r){yield new mfiv_1.RealTimeMfivStream(e,t,i,this.wssURL,s,o,r)}}exports.RealTimeBase=RealTimeBase,Object.defineProperty(exports,"__esModule",{value:!0}),exports.RealTimeMfivStream=exports.RealTimeMfiv=void 0;const consts_1=require("../consts"),multifeed_1=require("./multifeed"),realtimefeed_1=require("./realtimefeed");class RealTimeMfiv extends multifeed_1.MultiplexBase{constructor(){super(...arguments),this.wssURL="wss://ws.prd.volatility.com:8443/ws"}*_getRealTimeFeeds(e,t,i,s,o,r){yield new RealTimeMfivStream(e,t,i,this.wssURL,s,o,r)}}exports.RealTimeMfiv=RealTimeMfiv;class RealTimeMfivStream extends realtimefeed_1.RealTimeBase{constructor(e,t,i,s,o,r,n){super(e,t,i,o,r,n),this.wssURL=s}buildSubscribe(){return[{type:"SUBSCRIBE",channel:`${this._methodology}/${this._timePeriod}/`+this._asset}]}isHeartbeat(e){return e===consts_1.C.HEARTBEAT||super.isHeartbeat(e)}isError(e){return void 0!==e.error}}exports.RealTimeMfivStream=RealTimeMfivStream,Object.defineProperty(exports,"__esModule",{value:!0}),exports.MultiplexBase=void 0;const stream_1=require("stream");class MultiplexBase{constructor(e,t,i,s,o,r){this._methodology=e,this._timePeriod=t,this._asset=i,this._idleTimeout=s,this._apiKey=o,this._onError=r}[Symbol.asyncIterator](){return this._stream()}async*_stream(){const t=new stream_1.PassThrough({objectMode:!0,highWaterMark:8096});for(const i of this._getRealTimeFeeds(this._methodology,this._timePeriod,this._asset,this._idleTimeout,this._onError,this._apiKey))!async function(){for await(const e of i){if(t.destroyed)return;t.write(e)||await(0,stream_1.once)(t,"drain")}}();for await(const e of t)yield e}}exports.MultiplexBase=MultiplexBase;__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RealTimeBase=void 0;const debug_1=__importDefault(require("debug")),ws_1=__importDefault(require("ws")),utils_1=require("../utils");let connectionCounter=1;class RealTimeBase{constructor(e,t,i,s,o,r){this._methodology=e,this._timePeriod=t,this._asset=i,this._idleTimeout=s,this._onError=o,this._apiKey=r,this.ratelimit=0,this._receivedMessagesCount=0,this._connectionId=connectionCounter++,this._onConnectionEstabilished=async()=>{try{var e=this.buildSubscribe();this.onConnected();for(const t of e)this.send(t),0<this.ratelimit&&await(0,utils_1.wait)(this.ratelimit);for(this.debug("(connection id: %d) estabilished connection",this._connectionId);this._receivedMessagesCount<0;)await(0,utils_1.wait)(100);if(await(0,utils_1.wait)(+utils_1.ONE_SEC_IN_MS),this._ws.readyState===ws_1.default.CLOSED)return}catch(e){this.debug("(connection id: %d) providing manual snapshots error: %o",this._connectionId,e),this._ws.emit("error",e)}},this._onConnectionClosed=e=>{this.debug("(connection id: %d) connection closed %s",this._connectionId,e.reason)},this.debug=(0,debug_1.default)(`volatility-ws:realtime:${e}.${t}.`+i);s={authorization:"Bearer "+r};this._wsClientOptions={perMessageDeflate:!1,handshakeTimeout:10*utils_1.ONE_SEC_IN_MS,skipUTF8Validation:!0,headers:s},void 0!==utils_1.httpsProxyAgent&&(this._wsClientOptions.agent=utils_1.httpsProxyAgent)}[Symbol.asyncIterator](){return this._stream()}async*_stream(){let i,e,s=0;for(;;)try{var t,o=process.env.WSS_URL||this.wssURL,r=(this.debug("Connected to "+o),this._ws=new ws_1.default(o,this._wsClientOptions),this._ws.onopen=this._onConnectionEstabilished,this._ws.onclose=this._onConnectionClosed,i=this._monitorConnectionIfStale(),e=this.pingTimer(),ws_1.default.createWebSocketStream(this._ws,{readableObjectMode:!0,readableHighWaterMark:8096}));for await(t of r){void 0!==this.decompress&&(t=this.decompress(t));var n=JSON.parse(t);if(this.isError(n))throw new Error("Received error message:"+t.toString());this._receivedMessagesCount++,this.onMessage(n),yield n,0<s&&(s=0)}void 0!==i&&clearInterval(i),yield{_disconnect:!0}}catch(e){void 0!==this._onError&&this._onError(e),s++;var a=e.message.includes("429");let t;a?t=16e3*s:32e3<(t=1e3*Math.pow(2,s-1))&&(t=32e3),this.debug("(connection id: %d) %s.%s.%s real-time feed connection error, retries count: %d, next retry delay: %dms, rate limited: %s error message: %o",this._connectionId,this._methodology,this._timePeriod,this._asset,s,t,a,e),void 0!==i&&clearInterval(i),yield{_disconnect:!0},await(0,utils_1.wait)(t)}finally{void 0!==i&&clearInterval(i),void 0!==e&&clearInterval(e)}}send(e){void 0!==this._ws&&this._ws.readyState===ws_1.default.OPEN&&this._ws.send(JSON.stringify(e))}isHeartbeat(e){return!1}onMessage(e){}onConnected(){}_monitorConnectionIfStale(){if(void 0!==this._idleTimeout&&0!==this._idleTimeout)return setInterval(()=>{void 0!==this._ws&&(0===this._receivedMessagesCount&&(this.debug("(connection id: %d) did not received any messages within %d ms timeout, terminating connection...",this._connectionId,this._idleTimeout),this._ws.terminate()),this._receivedMessagesCount=0)},this._idleTimeout)}pingTimer(){return setInterval(()=>{void 0!==this._ws&&this._ws.readyState===ws_1.default.OPEN&&(this.debug("sending ping"),this._ws.ping())},5*utils_1.ONE_SEC_IN_MS)}}exports.RealTimeBase=RealTimeBase;
//# sourceMappingURL=dist/volatility-ws.min.js.map